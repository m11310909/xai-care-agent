// 1. è¼‰å…¥ç’°å¢ƒè®Šæ•¸
require('dotenv').config();

// 2. å¼•å…¥å¿…è¦å¥—ä»¶
const { Client } = require('@notionhq/client');
const simpleGit = require('simple-git');

// 3. å®šç¾©ä¸»åŠŸèƒ½å‡½å¼
async function logCommitsToNotion() {
  const notionToken = process.env.NOTION_TOKEN;
  const databaseId = process.env.NOTION_DB_ID;

  // 4. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
  if (!notionToken || !databaseId) {
    console.error('âŒ éŒ¯èª¤ï¼šè«‹è¨­å®š NOTION_TOKEN å’Œ NOTION_DB_ID');
    return;
  }

  console.log('ğŸš€ Notion Commit Logger å•Ÿå‹•...');

  try {
    // 5. åˆå§‹åŒ– Notion èˆ‡ Git
    const notion = new Client({ auth: notionToken });
    const git = simpleGit();

    console.log('ğŸ” æ­£åœ¨å¾ Git ç²å–æœ€æ–°çš„ commit ç´€éŒ„...');
    const log = await git.log(['-1']); // å–å¾—æœ€æ–°ä¸€ç­† commit

    if (!log.latest) {
      console.warn('âš ï¸ æ‰¾ä¸åˆ°ä»»ä½• Git commit ç´€éŒ„ï¼Œç¨‹å¼çµæŸã€‚');
      return;
    }

    const commit = log.latest;
    console.log(`ğŸ’¬ æº–å‚™å¯«å…¥ commit: "${commit.message}"`);

    // 6. å»ºç«‹ Notion é é¢è³‡æ–™æ ¼å¼
    const pageProperties = {
      parent: { database_id: databaseId },
      properties: {
        Name: {
          title: [{ text: { content: commit.message } }],
        },
        Author: {
          rich_text: [{ text: { content: commit.author_name } }],
        },
        Date: {
          date: {
            start: new Date(commit.date).toISOString(),
          },
        },
      },
    };

    // 7. å¯«å…¥ Notion
    await notion.pages.create(pageProperties);
    console.log('âœ… æˆåŠŸï¼Commit ç´€éŒ„å·²æ–°å¢è‡³ Notion è³‡æ–™åº«ã€‚');

  } catch (error) {
    console.error('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š');
    if (error.body) {
      console.error(JSON.parse(error.body));
    } else {
      console.error(error);
    }
  }
}

// 8. åŒ¯å‡ºæ¨¡çµ„
module.exports = {
  logCommitsToNotion,
};
